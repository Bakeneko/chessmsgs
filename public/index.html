<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>ChessMsgs</title>
  <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
  <style>
  html, body {
   overflow-x: hidden;
  }
  body {
      position: relative;
      background-color: #222222;
  }
  myBoard {
   overflow-x: hidden; 
  }
  </style>
</head>
<body>
<center>
<div id="myBoard" style="width: 600px;"></div>

<button id="flipOrientationBtn">Flip orientation</button>
<button id="clearBoardBtn">Clear Board</button>
<button id="startPositionBtn">Start Position</button>
<button id="showPiecesBtn">Toggle Extra Pieces</button>

</center>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="js/chessboard-1.0.0.js"></script>
<script>

var queryString = window.location.search;
var urlParams = new URLSearchParams(queryString);
var fen = urlParams.get('fen')
var prevFen = urlParams.get('prevFen')
var loading = true;

var extrasVisible = false;
var url = new URL(window.location);

function onChange (oldPos, newPos) {
  if(!loading) {
    console.log('Position changed:')
    console.log('Old position: ' + Chessboard.objToFen(oldPos))
    console.log('New position: ' + Chessboard.objToFen(newPos))
    console.log('~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~')
    
    url.searchParams.set('fen', Chessboard.objToFen(newPos));
    if(prevFen) url.searchParams.set('prevFen', prevFen);
    window.history.pushState({}, '', url);
//    copyToClipboard("https://chessmsgs.com/?fen=" + Chessboard.objToFen(newPos))

  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    console.log('Copying to clipboard was successful!');
  }, function(err) {
    console.error('Async: Could not copy text: ', err);
  });
}


var config = {
  draggable: true,
  position: 'start',
  onChange: onChange,
  sparePieces: true,
  moveSpeed: 800
}

function initBoard() {
  if(prevFen != null) board.position(prevFen,false)

  $('#flipOrientationBtn').on('click', board.flip)
  $('#clearBoardBtn').on('click', clearBoard)
  $('#startPositionBtn').on('click', startBoard)
  $('#showPiecesBtn').on('click', toggleExtraPieces)

  function clearBoard() {
    board.clear();
    url.searchParams.delete('fen');
    url.searchParams.delete('prevFen');
    window.history.pushState({}, '', url);
  }

  function startBoard() {
    board.start();
    url.searchParams.delete('fen');
    url.searchParams.delete('prevFen');
    window.history.pushState({}, '', url);
  }

  function toggleExtraPieces() {
    if(extrasVisible == false) {
      document.getElementsByClassName('spare-pieces-7492f')[0].style.visibility = 'visible';
      document.getElementsByClassName('spare-pieces-7492f')[1].style.visibility = 'visible';
      extrasVisible = true;
    } else {
      document.getElementsByClassName('spare-pieces-7492f')[0].style.visibility = 'hidden';
      document.getElementsByClassName('spare-pieces-7492f')[1].style.visibility = 'hidden';      
      extrasVisible = false;
    }
  }
}

var board = Chessboard('myBoard', config)
initBoard();

// Hide spare pieces
document.getElementsByClassName('spare-pieces-7492f')[0].style.visibility = 'hidden';
document.getElementsByClassName('spare-pieces-7492f')[1].style.visibility = 'hidden';

if(prevFen) {
  setTimeout(() => { board.position(fen,true); loading = false}, 500);

}
else {
  board.position(fen,false)
  loading = false;
}
prevFen = fen;

</script>

</body>
</html>

